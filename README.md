# 🔬 測定データ処理自動化ツール

このツールは、HZ-ANAソフトウェアによる測定データのCSV出力作業を自動化するツールです。

## ✨ 機能

- 🔍 HZ-ANAウィンドウの自動検出
- 📁 複数フォルダからの測定データファイル収集
- 📂 ファイルの自動オープン
- 💾 CSV形式での自動書き出し
- ⚠️ エラーハンドリングと進捗表示
- 🖥️ ユーザーフレンドリーなGUIインターフェース
- 🔧 pywin32による強力なウィンドウアクティブ化
- 🔄 アクティブ化失敗時の自動リトライ機能

## 🛠️ 必要な環境

- 💻 Windows 10/11
- 🐍 Python 3.7以上
- 📊 HZ-ANAソフトウェア（事前に起動しておく必要があります）
- 🔧 pywin32ライブラリ（より確実なウィンドウアクティブ化のため）

## 🚀 インストールと実行方法

### 方法1: バッチファイルを使用（推奨）

1. 📁 `run_processor.bat` をダブルクリックして実行
2. 👑 **管理者権限が必要な場合、自動的に管理者権限で再実行されます**
3. 📦 必要なライブラリが自動的にインストールされます
4. ▶️ ツールが起動します

### 方法2: 手動実行

1. 💻 コマンドプロンプトまたはPowerShellを**管理者権限で**開く
2. 📂 このフォルダに移動
3. 📝 以下のコマンドを実行：

```bash
# 必要なライブラリをインストール
pip install -r requirements.txt

# ツールを実行
python measurement_data_processor.py
```

### ⚠️ 重要な注意事項

- 🔒 **HZ-ANAソフトウェアが管理者権限で実行されている場合、このツールも管理者権限で実行する必要があります**
- 📋 **ファイルパスの入力はクリップボード経由で行われるため、より安全で確実です**
- 🚫 処理中はクリップボードを使用しないでください

## 📖 使用方法

### 1. 🔧 事前準備
   - ▶️ HZ-ANAソフトウェアを起動しておく
   - 📁 処理したい測定データファイルが入ったフォルダを準備

### 2. 🎯 ツールの実行
   - 🖱️ `run_processor.bat` をダブルクリック、またはPythonスクリプトを直接実行

### 3. 📂 フォルダ選択
   - 📁 処理対象のファイルが入っているフォルダを選択
   - 🔢 複数のフォルダを選択可能（一つずつ選択）
   - ❌ すべて選択し終わったら「キャンセル」を押す

### 4. ▶️ 処理開始
   - 📊 処理対象ファイル数を確認
   - ✅ 「はい」を選択し、HZ-ANAウィンドウをアクティブ化する
   - ⚠️ **注意: 処理中はマウスやキーボードを操作しないでください**

### 5. ✅ 処理完了
   - 📈 処理結果が表示されます
   - 📊 成功・失敗の件数と詳細が確認できます

## 📄 対応ファイル形式

以下の拡張子のファイルが処理対象となります：
- 📊 `.dat`
- 📝 `.txt`
- 📈 `.csv`
- 📋 `.tsv`
- 💾 `.data`

## ⚠️ 注意事項

- 🚫 **処理中は絶対にマウスやキーボードを操作しないでください**
- ✅ HZ-ANAソフトウェアが起動していることを確認してください
- 🆘 処理中にエラーが発生した場合、マウスを画面左上角に移動すると緊急停止できます
- ⏰ 大量のファイルを処理する場合は時間がかかります

## 🔧 トラブルシューティング

### 🔍 HZ-ANAウィンドウが見つからない
- ✅ HZ-ANAソフトウェアが起動しているか確認
- 🏷️ ウィンドウタイトルが「HZ-ANA」であることを確認

### 🖥️ ウィンドウアクティブ化の問題
- 🔧 pywin32による強力なアクティブ化: 従来のPyAutoGUIに加え、Windows APIを直接使用した確実なアクティブ化
- 🔄 自動リトライ機能: アクティブ化に失敗した場合、自動的に複数回再試行
- 🔓 最小化ウィンドウの復元: ウィンドウが最小化されている場合も自動的に復元
- 👑 権限問題の解決: 管理者権限で実行されているアプリケーションも適切に処理

**設定可能なオプション**:
- `USE_PYWIN32_FIRST`: pywin32を優先使用するか（デフォルト: True）
- `ACTIVATION_RETRY_COUNT`: 再試行回数（デフォルト: 2回）
- `ACTIVATION_RETRY_INTERVAL`: 再試行間隔（デフォルト: 0.5秒）

### 📁 ファイルが見つからない
- 📂 選択したフォルダに対応する拡張子のファイルがあるか確認
- 🔤 ファイルパスに日本語や特殊文字が含まれていないか確認

### ⏸️ 処理が途中で止まる
- 🔄 HZ-ANAソフトウェアの応答を確認
- 🆘 マウスを左上角に移動して緊急停止し、再実行

### 📦 ライブラリのインストールエラー
- 🌐 インターネット接続を確認
- 👑 管理者権限でコマンドプロンプトを実行
- 🔄 `pip install --upgrade pip` でpipを更新

---

## 👨‍💻 開発者向け情報

### 📁 ファイル構成

```
📦 測定データ処理自動化ツール/
├── 📄 measurement_data_processor.py  # メインプログラム
├── ⚙️ config.py                     # 設定ファイル
├── 📋 requirements.txt               # 必要なライブラリ一覧
├── 🚀 run_processor.bat             # 実行用バッチファイル
└── 📖 README.md                     # このファイル
```

### 🏗️ 全体構造

このツールは以下の主要コンポーネントで構成されています：

#### 1. 🎯 MeasurementDataProcessor クラス
メイン処理を担当するクラスです。GUI操作の自動化、ファイル処理、エラーハンドリングを統合的に管理します。

#### 2. ⚙️ 設定管理システム
`config.py`を通じて、タイミング調整やデバッグオプションを柔軟に設定できます。

#### 3. 🔧 エラーハンドリング
各処理段階でのエラー検出と適切な対応を行います。

### 📚 主要関数の詳細説明

#### 🔍 `check_hz_ana_window_exists()`
**目的**: HZ-ANAソフトウェアが起動しているかを確認

**処理フロー**:
1. 🔄 実行中プロセスの検索（psutilを使用）
2. 🏷️ ウィンドウタイトルの検索（PyAutoGUIを使用）
3. ✅ 検出結果の返却

**技術的詳細**:
- プロセス名とコマンドラインの両方をチェック
- 大文字小文字を区別しない検索
- 例外処理により安全性を確保

```python
# プロセス検索の例
for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
    if 'hz-ana' in proc.info['name'].lower():
        return True
```

#### 📂 `get_target_directories()`
**目的**: ユーザーから処理対象フォルダを複数選択

**処理フロー**:
1. 🖥️ Tkinterダイアログの表示
2. 🔄 フォルダ選択のループ処理
3. 🚫 重複チェック
4. 📋 選択結果のリスト化

**ユーザビリティ配慮**:
- 現在の選択数をタイトルに表示
- 重複選択の警告表示
- キャンセルによる選択終了

#### 📊 `collect_target_files()`
**目的**: 選択されたフォルダから処理対象ファイルを収集

**処理フロー**:
1. 📁 各ディレクトリの走査
2. 🔍 拡張子による絞り込み
3. 📋 ファイルパスリストの作成
4. 📊 統計情報の表示

**技術的詳細**:
- `pathlib.Path`を使用した安全なパス操作
- 設定ファイルからの拡張子リスト取得
- ファイル数制限の適用（デバッグ用）

```python
# 拡張子チェックの例
if file_path.suffix.lower() in target_extensions:
    files_in_dir.append(str(file_path))
```

#### 🖥️ `activate_hz_ana_window()`
**目的**: HZ-ANAウィンドウをアクティブ化

**処理フロー**:
1. 🔍 ウィンドウの検索
2. ▶️ アクティブ化の実行
3. ⏰ 安定化待機

**DRY RUN対応**:
- テストモード時は実際の操作をスキップ
- ログ出力による動作確認

**メモ**:
- `pyautogui`の`getWindowsWithTitle()`→`windows[0].activate()`を使用しているが、うまくアクティブ化されない場合がある
   - `pywin32`を使用してみたが、うまくウィンドウがアクティブ化されない問題は解決されていない
   - 処理開始まで時間を設けて、手動でウィンドウをアクティブ化する運用としてみる

#### 📂 `open_file_dialog()`
**目的**: HZ-ANA内でファイルを開くダイアログを表示

**キー操作シーケンス**:
```
Alt + F → Enter
```

**技術的詳細**:
- `pyautogui.hotkey()`による複合キー操作
- 設定可能な待機時間
- エラー時の適切な例外処理

#### 📝 `input_file_path_and_open()`
**目的**: ファイルパスを入力してファイルを開く

**キー操作シーケンス**:
```
クリップボード経由でファイルパス入力 → Enter → Tab → Space
```

**処理詳細**:
- `_input_text_via_clipboard()`によるクリップボード経由のテキスト入力
- 各操作間の適切な待機時間
- ファイル名のログ出力

**技術的改善点**:
- `pyautogui.write()`から`pyperclip`を使用したクリップボード経由の入力に変更
- 文字化けや入力エラーを防止
- 元のクリップボード内容の保存・復元

#### 🔧 `_input_text_via_clipboard()`
**目的**: クリップボード経由で安全にテキストを入力

**処理フロー**:
1. 📋 現在のクリップボード内容を保存
2. 📝 入力テキストをクリップボードにコピー
3. ⌨️ Ctrl+Vで貼り付け
4. 🔄 元のクリップボード内容を復元

**安全性の配慮**:
- 元のクリップボード内容の保護
- エラー時の適切な処理
- 文字化けの防止

#### 💾 `export_to_csv()`
**目的**: 開いたファイルをCSV形式で書き出し

**キー操作シーケンス**:
```
Alt + F → ↑ × 2 → Enter → Tab × N → (Space → ↓) × 3 → Tab × 10 → Space
```

**設定可能パラメータ**:
- `EXPORT_TAB_COUNT`: 出力形式選択までのTab数
- `EXPORT_SELECTION_COUNT`: 出力形式選択の回数
- `EXPORT_BUTTON_TAB_COUNT`: 書き出しボタンまでのTab数

#### 🔄 `process_single_file()`
**目的**: 単一ファイルの完全処理

**処理フロー**:
1. 📂 ファイルダイアログを開く
2. 📝 ファイルパスを入力して開く
3. 💾 CSV形式で書き出し
4. 📊 結果のログ出力

**エラーハンドリング**:
- 各ステップでの失敗検出
- 失敗時の即座な処理中断
- 詳細なエラーログ

#### 🎯 `run()`
**目的**: メイン処理の統合実行

**処理フロー**:
```
1. 🔍 HZ-ANAウィンドウ確認
2. 📂 フォルダ選択
3. 📊 ファイル収集
4. ✅ 処理開始確認
5. 🖥️ ウィンドウアクティブ化
6. 🔄 ファイル処理ループ
7. 📈 結果レポート
```

**エラーハンドリング**:
- 各段階での適切なエラー処理
- ユーザーフレンドリーなエラーメッセージ
- 緊急停止機能（Ctrl+C）

### ⚙️ 設定システム

#### 📋 設定カテゴリ

1. **🎮 PYAUTOGUI_SETTINGS**
   - `PAUSE`: 操作間の基本待機時間
   - `FAILSAFE`: 緊急停止機能の有効/無効

2. **🖥️ WINDOW_SETTINGS**
   - `TARGET_WINDOW_NAME`: 対象ウィンドウ名
   - `ACTIVATION_WAIT_TIME`: アクティブ化後の待機時間

3. **📁 FILE_SETTINGS**
   - `TARGET_EXTENSIONS`: 処理対象ファイル拡張子
   - `DIALOG_WAIT_TIME`: ダイアログ表示後の待機時間
   - `FILE_OPEN_WAIT_TIME`: ファイルオープン後の待機時間
   - `EXPORT_WAIT_TIME`: エクスポート後の待機時間
   - `PROCESS_INTERVAL`: ファイル処理間の待機時間

4. **🎮 GUI_OPERATIONS**
   - `EXPORT_TAB_COUNT`: エクスポート画面でのTab数
   - `EXPORT_SELECTION_COUNT`: 出力形式選択回数
   - `EXPORT_BUTTON_TAB_COUNT`: 書き出しボタンまでのTab数
   - `KEY_PRESS_INTERVAL`: キー操作間の短い待機時間

5. **🐛 DEBUG_SETTINGS**
   - `VERBOSE_OUTPUT`: 詳細ログの有効/無効
   - `DRY_RUN`: テストモード（実際のGUI操作なし）
   - `MAX_FILES_PER_SESSION`: 処理ファイル数制限

### 🔧 カスタマイズガイド

#### ⏰ タイミング調整
HZ-ANAソフトウェアの応答速度に応じて、以下の設定を調整してください：

```python
# 遅いマシンの場合
PYAUTOGUI_SETTINGS['PAUSE'] = 1.0
FILE_SETTINGS['DIALOG_WAIT_TIME'] = 2.0

# 高速なマシンの場合
PYAUTOGUI_SETTINGS['PAUSE'] = 0.3
FILE_SETTINGS['DIALOG_WAIT_TIME'] = 0.5
```

#### 🎮 GUI操作の調整
HZ-ANAのバージョンやレイアウトに応じて、Tab数を調整してください：

```python
# エクスポート画面のレイアウトが変わった場合
GUI_OPERATIONS['EXPORT_TAB_COUNT'] = 5  # デフォルト: 6
GUI_OPERATIONS['EXPORT_BUTTON_TAB_COUNT'] = 12  # デフォルト: 10
```

#### 📁 対応ファイル形式の追加
新しいファイル形式に対応する場合：

```python
FILE_SETTINGS['TARGET_EXTENSIONS'].extend(['.xyz', '.abc'])
```

### 🧪 テストとデバッグ

#### 🔍 DRY RUNモード
実際のGUI操作なしでロジックをテストできます：

```python
# config.py で設定
DEBUG_SETTINGS['DRY_RUN'] = True
```

#### 📊 詳細ログ
処理の詳細を確認したい場合：

```python
DEBUG_SETTINGS['VERBOSE_OUTPUT'] = True
```

#### 🧪 設定テスト
`test_config.py`を実行して設定の妥当性を確認：

```bash
python test_config.py
```

### 📝 コーディング規約

#### 🐍 Pythonスタイル
- PEP 8準拠
- 型ヒントの活用
- docstringによる詳細な説明

#### 📖 ドキュメント
- 関数レベルでの詳細説明
- 使用例の提供
- エラーケースの明記

## 📄 ライセンス

このツールは教育・研究目的で作成されています。
商用利用の場合は適切なライセンスを確認してください。 